name: Sync Fork (Multi-branch with Auto PR & Upstream Fallback)

on:
  schedule:
    - cron: '0 18 * * *'   # æ¯å¤©åŒ—äº¬æ—¶é—´ 02:00 (UTC 18:00)
  workflow_dispatch:       # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        branch: [main, master, dev]   # éœ€è¦åŒæ­¥çš„åˆ†æ”¯åˆ—è¡¨
    steps:
      # 1. æ£€å‡ºå½“å‰ fork ä»“åº“ä»£ç 
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      # 2. é…ç½® Git ç”¨æˆ·ä¿¡æ¯
      - name: Set up Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      # 3. è‡ªåŠ¨æ£€æµ‹ä¸Šæ¸¸ä»“åº“åœ°å€ï¼Œå¦‚æžœå¤±è´¥åˆ™ä½¿ç”¨æ‰‹å†™çš„å¤‡ç”¨åœ°å€
      - name: Detect or fallback upstream repo
        run: |
          FALLBACK="https://github.com/åŽŸä½œè€…/ä»“åº“å.git"
          UPSTREAM=$(curl -s https://api.github.com/repos/${{ github.repository }} \
            | jq -r '.parent.clone_url // empty')

          if [ -z "$UPSTREAM" ]; then
            echo "âš ï¸ æœªæ£€æµ‹åˆ° fork ä¸Šæ¸¸ï¼Œä½¿ç”¨å¤‡ç”¨åœ°å€: $FALLBACK"
            UPSTREAM=$FALLBACK
          else
            echo "âœ… è‡ªåŠ¨æ£€æµ‹åˆ°ä¸Šæ¸¸ä»“åº“: $UPSTREAM"
          fi

          git remote add upstream $UPSTREAM
          git fetch upstream

      # 4. åˆ›å»ºåŒæ­¥åˆ†æ”¯å¹¶åˆå¹¶ä¸Šæ¸¸æ›´æ–°ï¼ˆå¸¦åˆ†æ”¯å­˜åœ¨æ€§æ£€æµ‹ + å¿½ç•¥ workflow æ–‡ä»¶ï¼‰
      - name: Create sync branch
        run: |
          BRANCH="sync-${{ matrix.branch }}-$(date +%Y%m%d%H%M%S)"

          # æ£€æŸ¥ fork ä»“åº“æ˜¯å¦æœ‰è¯¥åˆ†æ”¯
          if ! git ls-remote --exit-code origin ${{ matrix.branch }} >/dev/null 2>&1; then
            echo "âš ï¸ å½“å‰ä»“åº“ä¸å­˜åœ¨åˆ†æ”¯ ${{ matrix.branch }}ï¼Œè·³è¿‡åŒæ­¥"
            exit 0
          fi

          # æ£€æŸ¥ä¸Šæ¸¸ä»“åº“æ˜¯å¦æœ‰è¯¥åˆ†æ”¯
          if ! git ls-remote --exit-code upstream ${{ matrix.branch }} >/dev/null 2>&1; then
            echo "âš ï¸ ä¸Šæ¸¸ä»“åº“ä¸å­˜åœ¨åˆ†æ”¯ ${{ matrix.branch }}ï¼Œè·³è¿‡åŒæ­¥"
            exit 0
          fi

          # ç¡®ä¿æœ¬åœ°æœ‰æœ€æ–°çš„åˆ†æ”¯å¼•ç”¨
          git fetch origin ${{ matrix.branch }} || true
          git fetch upstream ${{ matrix.branch }} || true

          # åˆ‡æ¢åˆ°ç›®æ ‡åˆ†æ”¯
          git checkout ${{ matrix.branch }} || git checkout -b ${{ matrix.branch }} origin/${{ matrix.branch }}

          # åˆå¹¶ä¸Šæ¸¸æ›´æ–°ï¼ˆå…è®¸å†²çªï¼ŒåŽç»­é€šè¿‡ PR è§£å†³ï¼‰
          git merge upstream/${{ matrix.branch }} || true

          # ä¸¢å¼ƒ workflow æ–‡ä»¶çš„æ”¹åŠ¨ï¼Œé¿å…æŽ¨é€å¤±è´¥
          git checkout HEAD -- .github/workflows/ || true
          git reset HEAD .github/workflows/ || true

          # æ–°å»ºåŒæ­¥åˆ†æ”¯ä¿å­˜åˆå¹¶ç»“æžœ
          git checkout -b $BRANCH

          # æŽ¨é€åˆ° fork ä»“åº“
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git $BRANCH

          # ä¿å­˜åˆ†æ”¯åä¾›åŽç»­æ­¥éª¤ä½¿ç”¨
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV

      # 5. è‡ªåŠ¨åˆ›å»º Pull Request
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Sync fork with upstream/${{ matrix.branch }}"
          branch: ${{ env.BRANCH }}
          title: "ðŸ”„ Sync fork: ${{ matrix.branch }}"
          body: |
            This PR was automatically created to sync changes from upstream/${{ matrix.branch }}.
            Workflow files were ignored to avoid permission issues.
            Please review and merge.
          base: ${{ matrix.branch }}
